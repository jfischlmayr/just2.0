@page "/Projects"
@using JUST.Data.Models;
@using JUST.Data;
@using JUST.Pages;
@using JUST.Shared;
@using Plk.Blazor.DragDrop;
@using Syncfusion.Blazor.DropDowns;
@using Syncfusion.Blazor.Buttons

@inject IProjectData _db;
@inject ITasksData _db_t;
@inject IJSRuntime js;
@inject NavigationManager NavigationManager;


<div class="pages">
	<h1>Projects</h1>
	<div class="projectcard-segment">
		@if (CountProjects() == 0)
		{
			<br/>
			<br/>
			<div class="no-open-task">
				No open Projects!
			</div>
		}
		else
		{
			@foreach (var p in projects)
			{
				<ProjectCard project="@p"></ProjectCard>
			}
		}
	</div>
</div>

@if(CountProjects() != 0)
{
	<div id="listbox2" class="listbox3">
		<h4 style="font-family:'Bebas Neue'; color: black;">All Tasks</h4>
		<SfListBox TValue="string[]" DataSource="@Tasks" Scope="combined-list" AllowDragAndDrop="true" Height="290px" TItem="JustTask">
			<ListBoxEvents TValue="string[]" TItem="JustTask" OnDrop="Change" Created="created"></ListBoxEvents>
			<ListBoxFieldSettings Text="Name" Value="ID" />
		</SfListBox>
	</div>
}


@code {
	List<Project> projects = new List<Project>();
    SfListBox<string[], JustTask> ListBoxObj = new SfListBox<string[], JustTask>();
	List<JustTask> Tasks { get; set; } = new();

	protected override async Task OnInitializedAsync()
	{
		projects = await _db.GetProjects();
		Tasks = await _db_t.GetTasks();
		Tasks = Tasks.Where(t => t.ProjectID == null).ToList();
	}

	 public int CountProjects()
    {
        int count = 0;
        foreach(var p in projects)
        {
            count ++;
        }
        return count;
    }

	private void Change(DropEventArgs<JustTask> args)
    {
		

		var task = args.Items.First();
		task.ProjectID = 2;
		_db_t.EditTask(task);

		Console.WriteLine(args.ToString());
		Console.WriteLine(args.Items.ToString());

		foreach(var item in args.Items)
		{
			Console.WriteLine(item.Name);
		}
    }

	private void created(object args)
    {
        ListBoxObj.EnableItems(Tasks, false);
    }
}

<style>
    #listbox2 {
        width: 48%;
        float: left;
    }
</style>